# 生产环境配置指南

本指南将帮助您在生产服务器上正确配置和部署系统采集项目。

## 配置方案选择

根据您当前的情况，选择合适的配置方案：

### 方案一：全新部署（推荐）

如果您的生产环境是全新的或者可以重新部署：

```bash
# 1. 创建项目目录
mkdir -p /www/wwwroot/tmocaiji
cd /www/wwwroot/tmocaiji

# 2. 克隆项目
git clone https://github.com/liking2354/sys-tmocaiji.git .

# 3. 运行初始化脚本
./scripts/deployment/init_production.sh
```

### 方案二：现有项目转换为Git管理

如果您已经有运行中的项目，想要启用Git管理：

```bash
# 1. 进入项目目录
cd /www/wwwroot/tmocaiji

# 2. 下载初始化脚本
wget https://raw.githubusercontent.com/liking2354/sys-tmocaiji/main/scripts/deployment/init_production.sh
chmod +x init_production.sh

# 3. 运行初始化脚本
./init_production.sh
```

### 方案三：手动配置Git仓库

如果您想手动配置：

```bash
cd /www/wwwroot/tmocaiji

# 初始化Git仓库
git init

# 添加远程仓库
git remote add origin https://github.com/liking2354/sys-tmocaiji.git

# 获取远程代码
git fetch origin

# 切换到主分支
git checkout -b main origin/main

# 如果有本地修改，需要处理冲突
git add .
git commit -m "本地现有文件"
git merge origin/main
```

## 详细配置步骤

### 1. 环境要求检查

确保服务器满足以下要求：

```bash
# 检查PHP版本 (需要 >= 8.0)
php -v

# 检查Composer
composer --version

# 检查Git
git --version

# 检查必要的PHP扩展
php -m | grep -E "(pdo|mysql|curl|json|mbstring|openssl|tokenizer|xml|ctype|fileinfo)"
```

### 2. 项目配置

```bash
cd /www/wwwroot/tmocaiji

# 复制环境配置文件
cp .env.example .env

# 编辑配置文件
vim .env
```

**重要配置项：**
```env
APP_NAME="系统采集项目"
APP_ENV=production
APP_DEBUG=false
APP_URL=http://your-domain.com

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=server_collector
DB_USERNAME=your_username
DB_PASSWORD=your_password

# 缓存配置
CACHE_DRIVER=redis
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis

# Redis配置
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379
```

### 3. 安装和配置

```bash
# 安装依赖
composer install --no-dev --optimize-autoloader

# 生成应用密钥
php artisan key:generate

# 创建存储链接
php artisan storage:link

# 运行数据库迁移
php artisan migrate

# 创建初始用户（如果需要）
php artisan db:seed --class=UserSeeder

# 优化性能（生产环境）
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

### 4. 设置文件权限

```bash
# 设置基本权限
find /www/wwwroot/tmocaiji -type f -exec chmod 644 {} \;
find /www/wwwroot/tmocaiji -type d -exec chmod 755 {} \;

# 设置特殊权限
chmod +x /www/wwwroot/tmocaiji/artisan
chmod -R 775 /www/wwwroot/tmocaiji/storage
chmod -R 775 /www/wwwroot/tmocaiji/bootstrap/cache

# 设置脚本权限
find /www/wwwroot/tmocaiji/scripts -name "*.sh" -exec chmod +x {} \;

# 设置所有者（根据实际情况调整）
chown -R www:www /www/wwwroot/tmocaiji
```

### 5. 配置定时任务

```bash
# 运行定时任务设置脚本
cd /www/wwwroot/tmocaiji
./scripts/maintenance/schedule_tasks.sh

# 或者手动添加到crontab
crontab -e
```

添加以下内容：
```cron
# Laravel调度任务
* * * * * cd /www/wwwroot/tmocaiji && php artisan schedule:run >> /dev/null 2>&1

# 任务状态重置
0 * * * * cd /www/wwwroot/tmocaiji && php artisan tasks:reset-stuck >> /dev/null 2>&1
```

### 6. Web服务器配置

#### Nginx配置示例

```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /www/wwwroot/tmocaiji/public;
    index index.php index.html;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.ht {
        deny all;
    }
}
```

#### Apache配置示例

```apache
<VirtualHost *:80>
    ServerName your-domain.com
    DocumentRoot /www/wwwroot/tmocaiji/public
    
    <Directory /www/wwwroot/tmocaiji/public>
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>
```

## 验证配置

### 1. 检查Git配置

```bash
cd /www/wwwroot/tmocaiji

# 检查Git状态
git status

# 检查远程仓库
git remote -v

# 测试更新功能
./scripts/maintenance/update.sh
```

### 2. 检查应用状态

```bash
# 检查Laravel配置
php artisan config:show

# 检查数据库连接
php artisan tinker --execute="DB::connection()->getPdo();"

# 检查定时任务
php artisan schedule:list

# 运行诊断脚本
./scripts/maintenance/diagnose_tasks.sh
```

### 3. 功能测试

1. 访问Web界面确认正常
2. 测试服务器管理功能
3. 测试采集任务执行
4. 检查任务状态重置功能

## 常见问题解决

### 1. 权限问题

```bash
# 重新设置权限
chmod -R 775 storage bootstrap/cache
chown -R www:www /www/wwwroot/tmocaiji
```

### 2. 缓存问题

```bash
# 清除所有缓存
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear
```

### 3. Git问题

```bash
# 重置Git状态
git reset --hard origin/main

# 强制更新
git fetch origin
git reset --hard origin/main
```

### 4. 任务状态问题

```bash
# 手动重置卡住的任务
php artisan tasks:reset-stuck

# 运行诊断
./scripts/maintenance/diagnose_tasks.sh
```

## 维护建议

1. **定期备份**：备份数据库和重要配置文件
2. **监控日志**：定期查看 `storage/logs/` 目录下的日志
3. **更新代码**：使用 `./scripts/maintenance/update.sh` 定期更新
4. **性能监控**：监控服务器资源使用情况
5. **安全检查**：定期检查文件权限和安全配置

## 联系支持

如果在配置过程中遇到问题，请：

1. 查看日志文件：`tail -f storage/logs/laravel.log`
2. 运行诊断脚本：`./scripts/maintenance/diagnose_tasks.sh`
3. 检查系统状态：`php artisan about`