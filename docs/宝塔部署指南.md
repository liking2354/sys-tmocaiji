# 宝塔面板部署指南 - TMO采集系统

## 前置条件

- 已安装宝塔面板的Linux服务器（推荐CentOS 7+或Ubuntu 18.04+）
- 已在宝塔面板中安装以下环境：
  - PHP 7.4+ (需安装扩展：fileinfo, redis, mysqli, pdo_mysql, mbstring, zip, gd, curl, xml)
  - MySQL 5.7+ 或 MariaDB 10.2+
  - Nginx 1.18+ 或 Apache 2.4+
  - Redis (可选，用于缓存)
  - Composer 2.0+

## 部署步骤

### 1. 创建网站和数据库

1. 登录宝塔面板
2. 创建网站
   - 点击左侧菜单"网站" → "添加站点"
   - 填写域名（如：tmocaiji.yourdomain.com）
   - 选择PHP版本（7.4+）
   - 勾选"创建FTP"和"创建数据库"
   - 记录生成的数据库名、用户名和密码
   - 点击提交

### 2. 上传代码

**方法一：通过宝塔面板上传**

1. 在本地将项目打包为zip文件
2. 在宝塔面板中，进入网站根目录（通常为/www/wwwroot/你的域名）
3. 点击"上传"按钮，上传zip文件
4. 解压文件：在文件列表中找到上传的zip文件，右键选择"解压"

**方法二：通过Git部署**

1. 在宝塔面板中，点击"终端"，进入命令行
2. 进入网站根目录：
   ```bash
   cd /www/wwwroot/你的域名
   ```
3. 克隆代码仓库：
   ```bash
   git clone 你的代码仓库地址 .
   ```

### 3. 配置项目

1. 复制环境配置文件：
   ```bash
   cp .env.example .env
   ```

2. 编辑.env文件，配置数据库连接：
   - 在宝塔面板中，找到网站根目录下的.env文件，点击"编辑"
   - 修改以下配置项：
     ```
     APP_NAME=TMO采集系统
     APP_ENV=production
     APP_DEBUG=false
     APP_URL=http://你的域名

     DB_CONNECTION=mysql
     DB_HOST=localhost
     DB_PORT=3306
     DB_DATABASE=你的数据库名
     DB_USERNAME=你的数据库用户名
     DB_PASSWORD=你的数据库密码
     ```

3. 设置目录权限：
   - 在宝塔面板中，点击"终端"，执行以下命令：
     ```bash
     cd /www/wwwroot/你的域名
     chmod -R 755 .
     chmod -R 777 storage
     chmod -R 777 bootstrap/cache
     chown -R www:www .
     ```

### 4. 安装依赖和初始化

1. 在宝塔面板中，点击"终端"，进入命令行
2. 进入网站根目录并安装依赖：
   ```bash
   cd /www/wwwroot/你的域名
   composer install --no-dev --optimize-autoloader
   ```

3. 生成应用密钥：
   ```bash
   php artisan key:generate
   ```

4. 运行数据库迁移：
   ```bash
   php artisan migrate
   ```

5. 清除缓存：
   ```bash
   php artisan config:cache
   php artisan route:cache
   php artisan view:cache
   ```

### 5. 配置Web服务器

**Nginx配置**

1. 在宝塔面板中，点击"网站" → 找到你的站点 → "设置"
2. 点击"配置文件"，修改Nginx配置：

```nginx
server {
    listen 80;
    server_name 你的域名;
    root /www/wwwroot/你的域名/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass unix:/tmp/php-cgi-74.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

3. 保存配置并重启Nginx

**Apache配置**

如果使用Apache，确保网站根目录下的.htaccess文件存在且内容正确。宝塔面板通常会自动配置Apache的虚拟主机。

### 6. 配置定时任务（如需要）

1. 在宝塔面板中，点击"计划任务"
2. 点击"添加计划任务"
3. 设置任务信息：
   - 任务类型：Shell脚本
   - 任务名称：Laravel调度器
   - 执行周期：*/1 * * * *（每分钟执行一次）
   - 脚本内容：
     ```bash
     cd /www/wwwroot/你的域名 && php artisan schedule:run >> /dev/null 2>&1
     ```

### 7. 配置SSL证书（推荐）

1. 在宝塔面板中，点击"网站" → 找到你的站点 → "设置" → "SSL"
2. 选择"Let's Encrypt"，申请免费的SSL证书
3. 填写相关信息并点击"申请"
4. 证书申请成功后，点击"开启强制HTTPS"

### 8. 验证部署

1. 在浏览器中访问你的网站域名
2. 确认系统正常运行，可以正常登录和使用各项功能

## 常见问题排查

### 500错误

1. 检查存储目录权限：
   ```bash
   chmod -R 777 storage bootstrap/cache
   ```

2. 检查.env文件是否存在且配置正确

3. 查看错误日志：
   - 在宝塔面板中，点击"网站" → 找到你的站点 → "日志"
   - 或查看Laravel日志：/www/wwwroot/你的域名/storage/logs/laravel.log

### 白屏或404错误

1. 确认网站根目录指向public目录
2. 检查Nginx/Apache配置是否正确
3. 确认URL重写规则配置正确

### 数据库连接错误

1. 检查.env文件中的数据库配置
2. 确认数据库用户有足够权限
3. 检查数据库服务是否正常运行

## 系统更新

当需要更新系统时，请按照以下步骤操作：

1. 备份数据库和代码
2. 拉取最新代码（如使用Git）：
   ```bash
   cd /www/wwwroot/你的域名
   git pull
   ```
3. 更新依赖：
   ```bash
   composer install --no-dev --optimize-autoloader
   ```
4. 运行数据库迁移：
   ```bash
   php artisan migrate
   ```
5. 清除缓存：
   ```bash
   php artisan config:cache
   php artisan route:cache
   php artisan view:cache
   ```

## 安全建议

1. 确保生产环境中APP_DEBUG设置为false
2. 定期更新系统和依赖包
3. 使用强密码并定期更换
4. 配置防火墙，只开放必要端口
5. 定期备份数据库和代码

## 性能优化

1. 启用Redis缓存：
   - 在.env文件中配置Redis连接
   - 设置CACHE_DRIVER=redis

2. 配置队列：
   - 在.env文件中设置QUEUE_CONNECTION=database或redis
   - 添加队列处理的计划任务：
     ```bash
     cd /www/wwwroot/你的域名 && php artisan queue:work --tries=3 --sleep=3 >> /dev/null 2>&1
     ```

3. 优化Nginx配置，添加静态文件缓存规则

4. 考虑使用CDN加速静态资源