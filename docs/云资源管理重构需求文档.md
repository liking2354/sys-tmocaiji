# 云资源管理重构需求文档

## 1. 项目概述

### 1.1 项目背景
当前云资源管理系统存在以下问题：
- 各云平台（阿里云、华为云、腾讯云）产品命名和API接口不统一
- 硬编码的资源类型和组件类型，缺乏灵活性
- 无法支持渐进式开发，难以分阶段实现不同组件
- 数据结构不够标准化，跨平台数据分析困难

### 1.2 项目目标
- 建立统一的云资源数据模型
- 实现基于数据字典的灵活配置管理
- 支持渐进式开发，可选择性同步不同平台的不同组件
- 提供标准化的数据存储和查询接口

### 1.3 技术架构
- **数据层**: 基于数据字典的灵活数据模型
- **服务层**: 抽象接口 + 平台适配器 + 组件处理器
- **应用层**: 配置管理界面 + 资源同步管理
- **展示层**: 统一的资源展示和分析界面

## 2. 业务需求

### 2.1 云平台分类
支持三大主流云平台：
- **华为云**: 弹性云服务器ECS、虚拟私有云VPC、弹性负载均衡ELB、云数据库RDS
- **阿里云**: 云服务器ECS、专有网络VPC、负载均衡SLB、云数据库RDS/MySQL
- **腾讯云**: 云服务器CVM、私有网络VPC、负载均衡CLB、云数据库CDB

### 2.2 资源分层
按业务功能分为三个层次：
- **计算资源**: 各平台的云服务器实例
- **网络资源**: VPC、负载均衡等网络组件
- **数据库资源**: 各类托管数据库服务

### 2.3 功能需求

#### 2.3.1 组件配置管理
- 支持选择性启用不同平台的不同组件
- 可视化的组件配置界面
- 支持组件同步优先级设置
- 支持组件特定参数配置

#### 2.3.2 资源同步管理
- 支持按平台同步资源
- 支持按组件类型同步资源
- 支持全量同步和增量同步
- 提供同步进度和结果反馈

#### 2.3.3 数据标准化
- 统一的资源数据模型
- 保留原始API数据用于扩展
- 支持跨平台数据对比和分析
- 提供标准化的查询接口

## 3. 技术需求

### 3.1 数据库设计

#### 3.1.1 数据字典表

##### dict_categories (字典分类表)
```sql
CREATE TABLE dict_categories (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    category_code VARCHAR(50) NOT NULL UNIQUE COMMENT '分类代码',
    category_name VARCHAR(100) NOT NULL COMMENT '分类名称',
    description TEXT COMMENT '分类描述',
    sort_order INT DEFAULT 0 COMMENT '排序',
    status ENUM('active', 'inactive') DEFAULT 'active' COMMENT '状态',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_category_code (category_code),
    INDEX idx_status (status)
) COMMENT '数据字典分类表';
```

##### dict_items (字典项表)
```sql
CREATE TABLE dict_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    category_id BIGINT NOT NULL COMMENT '分类ID',
    item_code VARCHAR(50) NOT NULL COMMENT '项目代码',
    item_name VARCHAR(100) NOT NULL COMMENT '项目名称',
    item_value VARCHAR(200) COMMENT '项目值',
    parent_id BIGINT COMMENT '父级ID',
    sort_order INT DEFAULT 0 COMMENT '排序',
    attributes JSON COMMENT '扩展属性',
    status ENUM('active', 'inactive') DEFAULT 'active' COMMENT '状态',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES dict_categories(id),
    FOREIGN KEY (parent_id) REFERENCES dict_items(id),
    UNIQUE KEY uk_category_code (category_id, item_code),
    INDEX idx_parent_id (parent_id),
    INDEX idx_status (status)
) COMMENT '数据字典项表';
```

#### 3.1.2 云资源管理表

##### cloud_platform_components (平台组件配置表)
```sql
CREATE TABLE cloud_platform_components (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    platform_id BIGINT NOT NULL COMMENT '云平台ID',
    component_dict_id BIGINT NOT NULL COMMENT '组件字典ID',
    is_enabled TINYINT(1) DEFAULT 0 COMMENT '是否启用',
    sync_priority INT DEFAULT 0 COMMENT '同步优先级',
    config JSON COMMENT '组件配置',
    last_sync_at TIMESTAMP NULL COMMENT '最后同步时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (platform_id) REFERENCES cloud_platforms(id),
    FOREIGN KEY (component_dict_id) REFERENCES dict_items(id),
    UNIQUE KEY uk_platform_component (platform_id, component_dict_id),
    INDEX idx_enabled (is_enabled),
    INDEX idx_sync_priority (sync_priority)
) COMMENT '云平台组件配置表';
```

##### cloud_resources (云资源主表)
```sql
CREATE TABLE cloud_resources (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    platform_id BIGINT NOT NULL COMMENT '云平台ID',
    resource_type_dict_id BIGINT NOT NULL COMMENT '资源类型字典ID',
    component_dict_id BIGINT NOT NULL COMMENT '组件类型字典ID',
    resource_id VARCHAR(100) NOT NULL COMMENT '云平台资源ID',
    resource_name VARCHAR(200) COMMENT '资源名称',
    region VARCHAR(50) COMMENT '区域',
    standard_data JSON COMMENT '标准化数据',
    raw_data JSON COMMENT '原始API数据',
    status ENUM('running', 'stopped', 'pending', 'error', 'unknown') DEFAULT 'unknown' COMMENT '状态',
    sync_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '同步时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (platform_id) REFERENCES cloud_platforms(id),
    FOREIGN KEY (resource_type_dict_id) REFERENCES dict_items(id),
    FOREIGN KEY (component_dict_id) REFERENCES dict_items(id),
    UNIQUE KEY uk_platform_resource (platform_id, component_dict_id, resource_id),
    INDEX idx_resource_type (resource_type_dict_id),
    INDEX idx_component_type (component_dict_id),
    INDEX idx_region (region),
    INDEX idx_status (status),
    INDEX idx_sync_at (sync_at)
) COMMENT '云资源主表';
```

##### cloud_compute_resources (计算资源扩展表)
```sql
CREATE TABLE cloud_compute_resources (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    resource_id BIGINT NOT NULL COMMENT '资源ID',
    instance_type VARCHAR(50) COMMENT '实例规格',
    cpu_cores INT COMMENT 'CPU核数',
    memory_gb DECIMAL(8,2) COMMENT '内存GB',
    os_type VARCHAR(50) COMMENT '操作系统类型',
    os_version VARCHAR(100) COMMENT '操作系统版本',
    disk_info JSON COMMENT '磁盘信息',
    private_ip VARCHAR(50) COMMENT '内网IP',
    public_ip VARCHAR(50) COMMENT '公网IP',
    vpc_id VARCHAR(100) COMMENT 'VPC ID',
    subnet_id VARCHAR(100) COMMENT '子网ID',
    security_groups JSON COMMENT '安全组',
    tags JSON COMMENT '标签',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (resource_id) REFERENCES cloud_resources(id) ON DELETE CASCADE,
    INDEX idx_instance_type (instance_type),
    INDEX idx_vpc_id (vpc_id),
    INDEX idx_private_ip (private_ip),
    INDEX idx_public_ip (public_ip)
) COMMENT '计算资源扩展表';
```

##### cloud_network_resources (网络资源扩展表)
```sql
CREATE TABLE cloud_network_resources (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    resource_id BIGINT NOT NULL COMMENT '资源ID',
    cidr_block VARCHAR(50) COMMENT 'CIDR块',
    gateway_ip VARCHAR(50) COMMENT '网关IP',
    dns_servers JSON COMMENT 'DNS服务器',
    route_tables JSON COMMENT '路由表',
    subnets JSON COMMENT '子网信息',
    load_balancer_type VARCHAR(50) COMMENT '负载均衡类型',
    listeners JSON COMMENT '监听器配置',
    backend_servers JSON COMMENT '后端服务器',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (resource_id) REFERENCES cloud_resources(id) ON DELETE CASCADE,
    INDEX idx_cidr_block (cidr_block),
    INDEX idx_gateway_ip (gateway_ip),
    INDEX idx_lb_type (load_balancer_type)
) COMMENT '网络资源扩展表';
```

##### cloud_database_resources (数据库资源扩展表)
```sql
CREATE TABLE cloud_database_resources (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    resource_id BIGINT NOT NULL COMMENT '资源ID',
    engine_type VARCHAR(50) COMMENT '数据库引擎类型',
    engine_version VARCHAR(50) COMMENT '数据库引擎版本',
    storage_gb INT COMMENT '存储容量GB',
    storage_type VARCHAR(50) COMMENT '存储类型',
    connection_info JSON COMMENT '连接信息',
    backup_config JSON COMMENT '备份配置',
    performance_config JSON COMMENT '性能配置',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (resource_id) REFERENCES cloud_resources(id) ON DELETE CASCADE,
    INDEX idx_engine_type (engine_type),
    INDEX idx_engine_version (engine_version),
    INDEX idx_storage_type (storage_type)
) COMMENT '数据库资源扩展表';
```

### 3.2 服务架构设计

#### 3.2.1 抽象接口层

##### 资源同步接口
```php
interface CloudResourceSyncInterface
{
    /**
     * 同步指定组件的资源
     */
    public function syncResources(array $componentTypes): array;
    
    /**
     * 获取启用的组件列表
     */
    public function getEnabledComponents(): array;
    
    /**
     * 将原始数据映射为标准格式
     */
    public function mapToStandardFormat(array $rawData, string $componentType): array;
    
    /**
     * 测试平台连接
     */
    public function testConnection(): bool;
}
```

##### 组件处理接口
```php
interface CloudComponentInterface
{
    /**
     * 获取资源列表
     */
    public function fetchResources(): array;
    
    /**
     * 转换数据格式
     */
    public function transformData(array $rawData): array;
    
    /**
     * 获取标准字段映射
     */
    public function getStandardFields(): array;
    
    /**
     * 获取组件类型
     */
    public function getComponentType(): string;
}
```

#### 3.2.2 平台适配器

##### 华为云适配器
```php
class HuaweiCloudAdapter implements CloudResourceSyncInterface
{
    protected $componentHandlers = [
        'ecs' => HuaweiEcsHandler::class,
        'vpc' => HuaweiVpcHandler::class,
        'elb' => HuaweiElbHandler::class,
        'rds' => HuaweiRdsHandler::class,
    ];
    
    protected $platform;
    protected $dictService;
    
    public function __construct(CloudPlatform $platform, DictService $dictService)
    {
        $this->platform = $platform;
        $this->dictService = $dictService;
    }
}
```

##### 阿里云适配器
```php
class AliyunAdapter implements CloudResourceSyncInterface
{
    protected $componentHandlers = [
        'ecs' => AliyunEcsHandler::class,
        'vpc' => AliyunVpcHandler::class,
        'slb' => AliyunSlbHandler::class,
        'rds' => AliyunRdsHandler::class,
    ];
}
```

##### 腾讯云适配器
```php
class TencentCloudAdapter implements CloudResourceSyncInterface
{
    protected $componentHandlers = [
        'cvm' => TencentCvmHandler::class,
        'vpc' => TencentVpcHandler::class,
        'clb' => TencentClbHandler::class,
        'cdb' => TencentCdbHandler::class,
    ];
}
```

#### 3.2.3 组件处理器

##### 华为云ECS处理器
```php
class HuaweiEcsHandler implements CloudComponentInterface
{
    protected $ecsClient;
    protected $dictService;
    
    public function fetchResources(): array
    {
        // 调用华为云ECS API获取服务器列表
        return $this->ecsClient->listServers();
    }
    
    public function transformData(array $rawData): array
    {
        // 将华为云ECS数据转换为标准格式
        return [
            'standard_data' => [
                'resource_name' => $rawData['name'],
                'instance_type' => $rawData['flavor']['id'],
                'cpu_cores' => $rawData['flavor']['vcpus'],
                'memory_gb' => $rawData['flavor']['ram'] / 1024,
                'os_type' => $rawData['metadata']['os_type'] ?? 'unknown',
                'private_ip' => $this->extractPrivateIp($rawData),
                'public_ip' => $this->extractPublicIp($rawData),
                'vpc_id' => $rawData['vpc_id'] ?? null,
                'status' => $this->mapStatus($rawData['status']),
            ],
            'raw_data' => $rawData
        ];
    }
    
    public function getStandardFields(): array
    {
        return [
            'resource_name', 'instance_type', 'cpu_cores', 'memory_gb',
            'os_type', 'private_ip', 'public_ip', 'vpc_id', 'status'
        ];
    }
    
    public function getComponentType(): string
    {
        return 'ecs';
    }
}
```

### 3.3 核心服务类

#### 3.3.1 数据字典服务
```php
class DictService
{
    /**
     * 获取字典分类下的所有项
     */
    public function getItemsByCategory(string $categoryCode): Collection;
    
    /**
     * 获取资源类型列表
     */
    public function getResourceTypes(): Collection;
    
    /**
     * 获取组件类型列表
     */
    public function getComponentTypes(string $resourceType = null): Collection;
    
    /**
     * 获取平台组件映射
     */
    public function getPlatformComponents(string $platform = null): Collection;
    
    /**
     * 根据代码获取字典项
     */
    public function getItemByCode(string $categoryCode, string $itemCode): ?DictItem;
    
    /**
     * 创建字典项
     */
    public function createItem(array $data): DictItem;
    
    /**
     * 更新字典项
     */
    public function updateItem(int $id, array $data): bool;
    
    /**
     * 删除字典项
     */
    public function deleteItem(int $id): bool;
}
```

#### 3.3.2 云资源同步管理器
```php
class CloudResourceSyncManager
{
    protected $dictService;
    protected $adapterFactory;
    
    /**
     * 按平台同步资源
     */
    public function syncByPlatform(int $platformId, array $componentTypes = []): array;
    
    /**
     * 同步所有平台资源
     */
    public function syncAllPlatforms(array $componentTypes = []): array;
    
    /**
     * 同步指定组件
     */
    public function syncComponent(int $platformId, string $componentType): array;
    
    /**
     * 获取同步状态
     */
    public function getSyncStatus(): array;
    
    /**
     * 清理过期资源
     */
    public function cleanupExpiredResources(int $days = 7): int;
}
```

#### 3.3.3 云资源查询服务
```php
class CloudResourceQueryService
{
    /**
     * 按条件查询资源
     */
    public function queryResources(array $filters = []): Collection;
    
    /**
     * 获取资源统计信息
     */
    public function getResourceStatistics(): array;
    
    /**
     * 按平台统计资源
     */
    public function getStatisticsByPlatform(): array;
    
    /**
     * 按资源类型统计
     */
    public function getStatisticsByResourceType(): array;
    
    /**
     * 获取资源详情
     */
    public function getResourceDetail(int $resourceId): ?CloudResource;
}
```

## 4. 界面需求

### 4.1 数据字典管理

#### 4.1.1 字典分类管理
- 路径: `/admin/dict/categories`
- 功能: 管理字典分类，支持增删改查
- 界面元素: 分类列表、新增分类表单、编辑分类表单

#### 4.1.2 字典项管理
- 路径: `/admin/dict/items`
- 功能: 管理字典项，支持层级结构
- 界面元素: 树形结构展示、拖拽排序、批量操作

### 4.2 云平台组件配置

#### 4.2.1 组件配置管理
- 路径: `/cloud/components`
- 功能: 配置各平台启用的组件
- 界面布局:
```
┌─────────────────────────────────────────────────────┐
│ 云平台组件配置                                        │
├─────────────────────────────────────────────────────┤
│ 平台    │ 计算资源      │ 网络资源        │ 数据库资源   │
├─────────────────────────────────────────────────────┤
│ 华为云  │ ☑ ECS        │ ☑ VPC          │ ☐ RDS       │
│         │ 弹性云服务器   │ 虚拟私有云       │ 云数据库     │
│         │              │ ☑ ELB          │             │
│         │              │ 弹性负载均衡     │             │
├─────────────────────────────────────────────────────┤
│ 阿里云  │ ☑ ECS        │ ☐ VPC          │ ☐ RDS       │
│         │ 云服务器      │ 专有网络        │ 云数据库     │
│         │              │ ☐ SLB          │ ☐ MySQL     │
│         │              │ 负载均衡        │ 云数据库     │
├─────────────────────────────────────────────────────┤
│ 腾讯云  │ ☐ CVM        │ ☐ VPC          │ ☐ CDB       │
│         │ 云服务器      │ 私有网络        │ 云数据库     │
│         │              │ ☐ CLB          │             │
│         │              │ 负载均衡        │             │
└─────────────────────────────────────────────────────┘
```

#### 4.2.2 同步配置
- 同步优先级设置
- 同步频率配置
- 组件特定参数配置

### 4.3 资源同步管理

#### 4.3.1 同步任务管理
- 路径: `/cloud/sync`
- 功能: 管理资源同步任务
- 界面元素: 
  - 手动同步按钮
  - 同步进度显示
  - 同步日志查看
  - 同步结果统计

#### 4.3.2 同步监控
- 实时同步状态显示
- 同步错误告警
- 同步性能监控

### 4.4 资源展示和查询

#### 4.4.1 资源列表
- 路径: `/cloud/resources`
- 功能: 展示所有云资源
- 界面元素:
  - 多条件筛选器
  - 分页列表
  - 资源详情弹窗
  - 批量操作

#### 4.4.2 资源统计
- 路径: `/cloud/statistics`
- 功能: 资源统计分析
- 界面元素:
  - 统计图表
  - 数据报表
  - 导出功能

## 5. 实施计划

### 5.1 第一阶段: 基础架构搭建 (预计2周)

#### 5.1.1 数据库设计实现
- [ ] 创建数据字典相关表
- [ ] 创建云资源管理相关表
- [ ] 编写数据库迁移文件
- [ ] 创建基础数据种子文件

#### 5.1.2 基础服务类实现
- [ ] 实现DictService数据字典服务
- [ ] 创建抽象接口定义
- [ ] 实现CloudResourceSyncManager基础框架
- [ ] 创建CloudResourceQueryService查询服务

#### 5.1.3 数据字典管理界面
- [ ] 字典分类管理页面
- [ ] 字典项管理页面
- [ ] 基础数据初始化

### 5.2 第二阶段: ECS组件实现 (预计3周)

#### 5.2.1 华为云ECS组件
- [ ] 实现HuaweiEcsHandler处理器
- [ ] 完成数据映射和转换逻辑
- [ ] 编写单元测试

#### 5.2.2 阿里云ECS组件
- [ ] 实现AliyunEcsHandler处理器
- [ ] 完成数据映射和转换逻辑
- [ ] 编写单元测试

#### 5.2.3 腾讯云CVM组件
- [ ] 实现TencentCvmHandler处理器
- [ ] 完成数据映射和转换逻辑
- [ ] 编写单元测试

#### 5.2.4 ECS资源管理界面
- [ ] 组件配置管理页面
- [ ] ECS资源同步功能
- [ ] ECS资源列表展示
- [ ] 同步状态监控

### 5.3 第三阶段: 网络组件实现 (预计3周)

#### 5.3.1 VPC组件实现
- [ ] 华为云VPC处理器
- [ ] 阿里云VPC处理器
- [ ] 腾讯云VPC处理器

#### 5.3.2 负载均衡组件实现
- [ ] 华为云ELB处理器
- [ ] 阿里云SLB处理器
- [ ] 腾讯云CLB处理器

#### 5.3.3 网络资源管理界面
- [ ] 网络资源配置页面
- [ ] 网络资源同步功能
- [ ] 网络资源展示界面

### 5.4 第四阶段: 数据库组件实现 (预计2周)

#### 5.4.1 数据库组件实现
- [ ] 华为云RDS处理器
- [ ] 阿里云RDS/MySQL处理器
- [ ] 腾讯云CDB处理器

#### 5.4.2 数据库资源管理
- [ ] 数据库资源配置
- [ ] 数据库资源同步
- [ ] 数据库资源展示

### 5.5 第五阶段: 优化和完善 (预计2周)

#### 5.5.1 性能优化
- [ ] 同步性能优化
- [ ] 数据库查询优化
- [ ] 缓存机制实现

#### 5.5.2 功能完善
- [ ] 错误处理完善
- [ ] 日志记录优化
- [ ] 监控告警功能
- [ ] 文档完善

## 6. 验收标准

### 6.1 功能验收
- [ ] 支持三大云平台的资源同步
- [ ] 支持选择性组件同步
- [ ] 数据字典管理功能完整
- [ ] 资源数据标准化存储
- [ ] 同步状态监控正常

### 6.2 性能验收
- [ ] 单平台资源同步时间 < 5分钟
- [ ] 资源列表查询响应时间 < 2秒
- [ ] 支持并发同步操作
- [ ] 内存使用合理

### 6.3 质量验收
- [ ] 代码覆盖率 > 80%
- [ ] 无严重安全漏洞
- [ ] 界面友好易用
- [ ] 文档完整准确

## 7. 风险评估

### 7.1 技术风险
- **云平台API变更**: 各云平台API可能发生变更，需要及时适配
- **数据量过大**: 大量云资源可能导致同步性能问题
- **网络稳定性**: 云平台API调用可能因网络问题失败

### 7.2 业务风险
- **需求变更**: 业务需求可能在开发过程中发生变化
- **数据准确性**: 不同平台数据格式差异可能导致映射错误

### 7.3 风险应对
- 建立API版本兼容机制
- 实现分批同步和断点续传
- 增加重试机制和错误恢复
- 保持需求沟通和及时调整
- 建立数据校验和监控机制

## 8. 附录

### 8.1 相关文档
- 华为云API文档
- 阿里云API文档
- 腾讯云API文档
- Laravel框架文档

### 8.2 开发规范
- PSR-4自动加载规范
- PSR-12编码规范
- Laravel最佳实践
- 数据库设计规范

### 8.3 测试策略
- 单元测试覆盖核心业务逻辑
- 集成测试验证API调用
- 功能测试验证用户界面
- 性能测试验证系统性能

---

**文档版本**: v1.0  
**创建日期**: 2025-10-15  
**最后更新**: 2025-10-15  
**文档状态**: 待评审