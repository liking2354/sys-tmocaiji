# 第二阶段快速指南：模块化脚本提取

## 工作流程

### 步骤 1：识别需要提取的脚本
在 Blade 模板中查找 `@section('scripts')` 或 `@push('scripts')`

```bash
grep -r "@section('scripts')" resources/views/
grep -r "@push('scripts')" resources/views/
```

### 步骤 2：创建模块脚本文件
在 `public/assets/js/modules/` 中创建对应的 `.js` 文件

**命名规则**：
- 服务器管理 → `servers.js`
- 采集任务 → `collection-tasks.js`
- 系统变更 → `system-change.js`
- 等等...

### 步骤 3：提取脚本内容
1. 复制 Blade 模板中 `<script>` 标签内的所有代码
2. 粘贴到新的模块文件中
3. 替换硬编码的路由为全局变量

**示例转换**：

```javascript
// 之前（在 Blade 中）
url: '{{ route("servers.download") }}',

// 之后（在模块中）
url: window.serversDownloadRoute,
```

### 步骤 4：设置全局变量
在 Blade 模板中添加 `@push('scripts')` 块来设置全局变量

```blade
@push('scripts')
<script>
    window.csrfToken = '{{ csrf_token() }}';
    window.serversDownloadRoute = '{{ route("servers.download") }}';
    // ... 其他变量
</script>
<script src="{{ asset('assets/js/modules/servers.js') }}"></script>
@endpush
```

### 步骤 5：移除原始脚本
删除 Blade 模板中的 `@section('scripts')` 块

## 常见模式

### 模式 1：简单的事件处理
```javascript
// 在模块中
$(document).ready(function() {
    $('#button').click(function() {
        // 处理逻辑
    });
});
```

### 模式 2：AJAX 请求
```javascript
// 在模块中
$.ajax({
    url: window.apiRoute,  // 使用全局变量
    type: 'POST',
    headers: {
        'X-CSRF-TOKEN': window.csrfToken  // 使用全局变量
    },
    // ...
});
```

### 模式 3：全局函数
```javascript
// 在模块中
window.myFunction = function(param) {
    // 函数实现
};

// 在 HTML 中调用
<button onclick="myFunction('value')">Click</button>
```

## 优先级顺序

### 第一优先级（高）
1. `servers/show.blade.php` - 服务器详情页面
2. `collection-tasks/show.blade.php` - 采集任务详情页面
3. `system-change/tasks/index.blade.php` - 系统变更任务列表

### 第二优先级（中）
4. `system-change/templates/create-visual.blade.php` - 模板创建
5. `system-change/templates/edit-visual.blade.php` - 模板编辑
6. `system-change/tasks/create.blade.php` - 任务创建

### 第三优先级（低）
7. `data/cleanup.blade.php` - 数据清理
8. 其他管理页面

## 检查清单

提取每个模块时，确保：

- [ ] 创建了对应的 `.js` 文件
- [ ] 复制了所有脚本代码
- [ ] 替换了所有硬编码的路由
- [ ] 设置了所有必需的全局变量
- [ ] 在 Blade 中添加了 `@push('scripts')` 块
- [ ] 移除了原始的 `@section('scripts')` 块
- [ ] 测试了功能是否正常工作
- [ ] 检查浏览器控制台是否有错误

## 常见问题

### Q: 如何处理 Blade 模板中的变量？
A: 在 Blade 中设置全局变量，然后在模块中使用：

```blade
<!-- 在 Blade 中 -->
<script>
    window.taskId = {{ $task->id }};
    window.taskData = @json($task);
</script>
```

```javascript
// 在模块中
console.log(window.taskId);
console.log(window.taskData);
```

### Q: 如何处理内联样式？
A: 暂时保留在 Blade 中，第四阶段再提取到 CSS 文件。

### Q: 如何测试提取后的脚本？
A: 
1. 打开浏览器开发者工具（F12）
2. 检查 Console 标签是否有错误
3. 测试相关功能是否正常工作
4. 检查 Network 标签中的 AJAX 请求

### Q: 如何处理多个 Blade 文件共享的脚本？
A: 创建一个通用模块文件，例如 `common-tasks.js`，然后在多个 Blade 文件中引用。

## 示例：完整的提取过程

### 原始 Blade 文件（部分）
```blade
@section('scripts')
<script>
    $(document).ready(function() {
        $('#deleteBtn').click(function() {
            if (confirm('确定删除吗？')) {
                $.ajax({
                    url: '{{ route("items.destroy") }}',
                    type: 'POST',
                    data: { _token: '{{ csrf_token() }}' },
                    success: function() {
                        alert('删除成功');
                    }
                });
            }
        });
    });
</script>
@endsection
```

### 新建模块文件 `public/assets/js/modules/items.js`
```javascript
$(document).ready(function() {
    $('#deleteBtn').click(function() {
        if (confirm('确定删除吗？')) {
            $.ajax({
                url: window.itemsDestroyRoute,
                type: 'POST',
                data: { _token: window.csrfToken },
                success: function() {
                    alert('删除成功');
                }
            });
        }
    });
});
```

### 更新后的 Blade 文件
```blade
@push('scripts')
<script>
    window.csrfToken = '{{ csrf_token() }}';
    window.itemsDestroyRoute = '{{ route("items.destroy") }}';
</script>
<script src="{{ asset('assets/js/modules/items.js') }}"></script>
@endpush
```

## 性能提示

1. **脚本加载**：模块脚本在 `app.blade.php` 中加载，确保在 jQuery 和其他依赖之后
2. **缓存**：浏览器会缓存 `.js` 文件，提高性能
3. **最小化**：生产环境中应该最小化 JavaScript 文件

## 下一步

完成第二阶段后：
1. 运行完整的功能测试
2. 检查浏览器兼容性
3. 优化性能
4. 准备第三阶段（样式模块化）
